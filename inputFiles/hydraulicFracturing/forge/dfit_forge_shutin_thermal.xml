<?xml version="1.0" ?>

<Problem>
  <Solvers
    gravityVector="{ 0.0, 0.0, 0.0 }">
    <Hydrofracture
      name="hydrofracture"
      solidSolverName="lagsolve"
      flowSolverName="SinglePhaseFlow"
      surfaceGeneratorName="SurfaceGen"
      logLevel="1"
      isThermal="1"
      targetRegions="{ Fracture }"
      contactRelationName="fractureContact"
      maxNumResolves="8"
      initialDt="0.1">
      <NonlinearSolverParameters
        newtonTol="1.0e-4"
        newtonMaxIter="20"
	      maxAllowedResidualNorm="1e40"
        maxTimeStepCuts="6"
        maxSubSteps="20"/>
      <LinearSolverParameters
        solverType="bicgstab"
        krylovMaxIter="500"/>
    </Hydrofracture>

    <SolidMechanicsLagrangianSSLE
      name="lagsolve"
      timeIntegrationOption="QuasiStatic"
      logLevel="1"
      discretization="FE1"
      targetRegions="{ Domain, Fracture }"
      contactRelationName="fractureContact">
    </SolidMechanicsLagrangianSSLE>

    <SinglePhaseFVM
      name="SinglePhaseFlow"
      logLevel="1"
      isThermal="1"
      discretization="singlePhaseTPFA"
      targetRegions="{ Domain, Fracture }">
    </SinglePhaseFVM>

    <!-- <SinglePhaseFVM
      name="SinglePhaseFlow"
      logLevel="1"
      discretization="singlePhaseTPFA"
      targetRegions="{ Domain, Fracture }">
    </SinglePhaseFVM> -->

    <SurfaceGenerator
      name="SurfaceGen"
      targetRegions="{ Fracture }"
      nodeBasedSIF="1"      
      rockToughness="1e30"
      mpiCommOrder="1"/>
  </Solvers>

  <Mesh>
    <InternalMesh
      name="mesh1"
      elementTypes="{ C3D8 }"
      xCoords="{ 0, 80, 120, 200 }"
      yCoords="{ 0, 75, 100, 125, 200 }"
      zCoords="{ 0, 75, 100, 125, 200 }"
      nx="{ 4, 10, 4 }"
      ny="{ 15, 50, 50, 15 }"
      nz="{ 15, 50, 50, 15 }"
      cellBlockNames="{ cb1 }"/>
  </Mesh>

  <Events
    maxTime="1600">
    <SoloEvent
      name="preFracture"
      target="/Solvers/SurfaceGen"/>

    <PeriodicEvent
      name="outputs0"
      cycleFrequency="2"
      target="/Outputs/vtkOutput"/>
    
    <!-- compute initial condition -->
    <PeriodicEvent
      name="solverApplications0"
      beginTime="0.0"
      endTime="1.0"
      forceDt="0.1"
      target="/Solvers/hydrofracture"/>
    
    <!-- start closure process -->
    <PeriodicEvent
      name="solverApplications1"
      beginTime="1.0"
      endTime="10.0"
      maxEventDt="1.0"
      target="/Solvers/hydrofracture"/>

    <PeriodicEvent
      name="solverApplications2"
      beginTime="10.0"
      endTime="30.0"
      maxEventDt="1.0"
      target="/Solvers/hydrofracture"/>

    <PeriodicEvent
      name="solverApplications3"
      beginTime="30.0"
      endTime="40.0"
      maxEventDt="1.0"
      target="/Solvers/hydrofracture"/>  

    <PeriodicEvent
      name="solverApplications4"
      beginTime="40.0"
      endTime="51.0"
      maxEventDt="1.0"
      target="/Solvers/hydrofracture"/>  

    <PeriodicEvent
      name="solverApplications5"
      beginTime="51.0"
      endTime="1601.0"
      maxEventDt="10.0"
      target="/Solvers/hydrofracture"/>

  </Events>

  <ElementRegions>
    <CellElementRegion
      name="Domain"
      cellBlocks="{ cb1 }"
      materialList="{ water, porousRock, rock, thermalCond }"/>

    <SurfaceElementRegion
      name="Fracture"      
      defaultAperture="12e-3"
      materialList="{ water, rock, fractureFilling, fractureContact, thermalCondFrac }"/>
  </ElementRegions>

  <Constitutive>
    <ThermalCompressibleSinglePhaseFluid
      name="water"
      defaultDensity="1000"
      defaultViscosity="1.0e-3"
      referencePressure="20.8e6"
      referenceTemperature="273.0"
      compressibility="5e-10"
      thermalExpansionCoeff="0.0"
      viscosibility="0.0"
      specificHeatCapacity="4.2e3"
      referenceInternalEnergy="1.1e6"/>

    <SinglePhaseConstantThermalConductivity
       name="thermalCond"
       thermalConductivityComponents="{ 3.81, 3.81, 3.81 }"/>  
      
    <SinglePhaseConstantThermalConductivity
       name="thermalCondFrac"
       thermalConductivityComponents="{ 0.2, 0.2, 200.0 }"/>  

    <CompressibleSolidConstantPermeability
       name="porousRock"
       solidModelName="nullSolid"
       porosityModelName="rockPorosity"
       permeabilityModelName="rockPerm"
       solidInternalEnergyModelName="rockInternalEnergy"/>
    
    <!-- <CompressibleSolidConstantPermeability
       name="porousRock"
       solidModelName="nullSolid"
       porosityModelName="rockPorosity"
       permeabilityModelName="rockPerm"/> -->

    <PressurePorosity
       name="rockPorosity"
       defaultReferencePorosity="0.01"
       referencePressure="20.8e6"
       compressibility="1.9e-9"/>

    <ConstantPermeability
       name="rockPerm"
       permeabilityComponents="{ 8e-16, 8e-16, 8e-16 }"/> 

    <ElasticIsotropic
      name="rock"
      defaultDensity="2700"
      defaultBulkModulus="33.3333333333e9"
      defaultShearModulus="20e9"
      defaultDrainedLinearTEC="6e-6"/>

    <CompressibleSolidParallelPlatesPermeability
      name="fractureFilling"
      solidModelName="nullSolid"
      porosityModelName="fracturePorosity"
      permeabilityModelName="fracturePerm"
      solidInternalEnergyModelName="rockInternalEnergy"/>

    <!-- <CompressibleSolidParallelPlatesPermeability
      name="fractureFilling"
      solidModelName="nullSolid"
      porosityModelName="fracturePorosity"
      permeabilityModelName="fracturePerm"/> -->

    <SolidInternalEnergy
      name="rockInternalEnergy"
      volumetricHeatCapacity="3e6"
      referenceTemperature="273.0"
      referenceInternalEnergy="8.19e8"/> 

    <NullModel
      name="nullSolid"/>

    <PressurePorosity
      name="fracturePorosity"
      defaultReferencePorosity="1.00"
      referencePressure="0.0"
      compressibility="0.0"/>

    <ParallelPlatesPermeability
      name="fracturePerm"
      transversalPermeability="8e-16"
      timeLagFlag="1"/>

    <FrictionlessContact
      name="fractureContact"
      penaltyStiffness="1e12"
      useApertureModel="2"
      refNormalStress="50e6"/>
  </Constitutive>

  <NumericalMethods>
    <FiniteElements>
      <FiniteElementSpace
        name="FE1"
        order="1"/>
    </FiniteElements>

    <FiniteVolume>
      <TwoPointFluxApproximation
        name="singlePhaseTPFA"/>
    </FiniteVolume>
  </NumericalMethods>
 
  <FieldSpecifications>
    <FieldSpecification
      name="separableFace"
      initialCondition="1"
      setNames="{ fracture }"
      objectPath="faceManager"
      fieldName="isFaceSeparable"
      scale="1"/>

    <FieldSpecification
      name="frac"
      initialCondition="1"
      setNames="{ fracture }"
      objectPath="faceManager"
      fieldName="ruptureState"
      functionName="ruptureFunction"
      scale="1"/>

    <FieldSpecification 
      name="Sh"
      initialCondition="1"
      setNames="{ all }"
      objectPath="ElementRegions/Domain/cb1"
      fieldName="rock_stress"
      component="0"
      scale="-44.5e6"/>

    <FieldSpecification 
      name="SH"
      initialCondition="1"
      setNames="{ all }"
      objectPath="ElementRegions/Domain/cb1"
      fieldName="rock_stress"
      component="1"
      scale="-50.7e6"/>

    <FieldSpecification 
      name="Sv"
      initialCondition="1"
      setNames="{ all }"
      objectPath="ElementRegions/Domain/cb1"
      fieldName="rock_stress"
      component="2"
      scale="-65.2e6"/>

    <FieldSpecification
       name="initialPressure"
       initialCondition="1"
       objectPath="ElementRegions/Domain/cb1"
       fieldName="pressure"
       setNames="{all}"
       scale="20.8e6"/>

    <FieldSpecification
      name="initialTemperature"
      initialCondition="1"
      setNames="{ all }"
      objectPath="ElementRegions/Domain/cb1"
      fieldName="temperature"
      scale="472"/>
    
    <FieldSpecification
       name="initialPressureFracture"
       initialCondition="1"
       objectPath="ElementRegions/Fracture"
       fieldName="pressure"
       setNames="{all}"
       scale="1.0"
       functionName="presFunction"/>
       
    <FieldSpecification
       name="fracturePressure"
       objectPath="ElementRegions/Fracture"
       fieldName="pressure"
       setNames="{all}"
       scale="1.0"
       functionName="presFunction"
       beginTime="0.0"
       endTime="1.0"/>       

    <FieldSpecification
       name="initialTempFracture"
       initialCondition="1"
       objectPath="ElementRegions/Fracture"
       fieldName="temperature"
       setNames="{all}"
       scale="1.0"
       functionName="tempFunction"/>
       
    <FieldSpecification
       name="fractureTemp"
       objectPath="ElementRegions/Fracture"
       fieldName="temperature"
       setNames="{all}"
       scale="1.0"
       functionName="tempFunction"
       beginTime="0.0"
       endTime="1.0"/>    

    <FieldSpecification
      name="yconstraint"
      objectPath="nodeManager"
      fieldName="totalDisplacement"
      component="1"
      scale="0.0"
      setNames="{ yneg, ypos }"/>

    <FieldSpecification
      name="zconstraint"
      objectPath="nodeManager"
      fieldName="totalDisplacement"
      component="2"
      scale="0.0"
      setNames="{ zneg, zpos }"/>

    <FieldSpecification
      name="xconstraint"
      objectPath="nodeManager"
      fieldName="totalDisplacement"
      component="0"
      scale="0.0"
      setNames="{ xneg, xpos }"/>
  </FieldSpecifications>

  <Geometry>
    <Cylinder 
      firstFaceCenter="{ 99.99, 100, 100 }" 
      outerRadius="25" 
      secondFaceCenter="{ 100.01, 100, 100 }" 
      name="fracture" />
  </Geometry>

  <Functions>
    <TableFunction
      name="presFunction"
      inputVarNames="{ elementCenter }"
      coordinateFiles="{ table_thermal/xlin.geos, table_thermal/ylin.geos, table_thermal/zlin.geos }"
      voxelFile="table_thermal/pres.geos"
      interpolation="nearest"/> 

    <TableFunction
      name="tempFunction"
      inputVarNames="{ elementCenter }"
      coordinateFiles="{ table_thermal/xlin.geos, table_thermal/ylin.geos, table_thermal/zlin.geos }"
      voxelFile="table_thermal/temp.geos"
      interpolation="nearest"/> 

    <TableFunction
      name="ruptureFunction"
      inputVarNames="{ faceCenter }"
      coordinateFiles="{ table_thermal/xlin.geos, table_thermal/ylin.geos, table_thermal/zlin.geos }"
      voxelFile="table_thermal/rupture.geos"
      interpolation="nearest"/> 
  </Functions>

  <!-- <Tasks>
    <PackCollection
      name="pressureCollection"
      objectPath="ElementRegions/Fracture/FractureSubRegion"
      fieldName="pressure"/>
  </Tasks> -->

  <Outputs>
    <VTK
      name="vtkOutput"
      plotFileRoot="dfit_forge_shutin_timeLag_exp_thermal"/>

    <!-- <TimeHistory
      name="pressureHistoryOutput"
      sources="{/Tasks/pressureCollection}"
      filename="forge-58-32_injPressure_history"/>      -->
  </Outputs>

</Problem>
