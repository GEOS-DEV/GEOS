name: Build and Test Configuration
on:
  workflow_call:
    inputs:
      BUILD_AND_TEST_ARGS:
        required: false
        type: string
      build_type:
        required: false
        type: string
        default: build
      CMAKE_BUILD_TYPE:
        required: true
        type: string
      COMMIT:
        required: true
        type: string
      DOCKER_IMAGE_TAG:
        required: true
        type: string
      DOCKER_REPOSITORY:
        required: true
        type: string
      ENABLE_HYPRE:
        required: false
        type: string
      ENABLE_HYPRE_DEVICE:
        required: false
        type: string
      ENABLE_TRILINOS:
        required: false
        type: string
      GCP_BUCKET:
        required: false
        type: string
      HOST_CONFIG:
        required: false
        type: string
      RUNS_ON:
        required: true
        type: string
      USE_SCCACHE:
        required: false
        type: boolean
        default: true
    secrets:
      GOOGLE_CLOUD_GCP:
        required: false
jobs:
  build_and_test:
    runs-on: ${{ inputs.RUNS_ON }}
    env:
      # Those env variables could be passed as scripts parameters as well,
      # but a specific care must be taken to be sure there's no conflict with the host-config files.
      ENABLE_HYPRE: ${{ inputs.ENABLE_HYPRE }}
      ENABLE_HYPRE_DEVICE: ${{ inputs.ENABLE_HYPRE_DEVICE }}
      ENABLE_TRILINOS: ${{ inputs.ENABLE_TRILINOS }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        submodules: true
        # lfs: ${{ inputs.build_type == 'integrated_tests' }}
        lfs: false
        fetch-depth: 1

    - id: 'auth'
      if: ${{ inputs.GCP_BUCKET || inputs.USE_SCCACHE }}
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CLOUD_GCP }}'
        create_credentials_file: true

    - name: 'Set up Cloud SDK'
      if: inputs.GCP_BUCKET
      uses: 'google-github-actions/setup-gcloud@v1'
      with:
        version: '>= 363.0.0'

    - name: Print environment
      run: printenv

    # Build and test only
    # Builds only the geos executable (timeout when building tests)
    - name: Build and test
      if: ${{ inputs.build_type == 'build' && !(inputs.GCP_BUCKET) }}
      run: |
        HC=${{ inputs.HOST_CONFIG }}
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --use-sccache ${{ inputs.USE_SCCACHE }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
          ${HC:+"--host-config ${HC}"} \
          ${{ inputs.BUILD_AND_TEST_ARGS }}

    # Build, test, uploads geos and its TPL to GCP/GCS using gcloud CLI
    - name: Build and test and deploy
      if: ${{ inputs.build_type == 'build' && inputs.GCP_BUCKET }}
      run: |
        HC=${{ inputs.HOST_CONFIG }}
        # `source' command doesn't work with process substitution in bash, so we use an extra variable `HC_CLI'.
        HC_CLI=${HC:+"--host-config ${HC}"}
        source ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --use-sccache ${{ inputs.USE_SCCACHE }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
          ${HC_CLI} \
          ${{ inputs.BUILD_AND_TEST_ARGS }}
        TMP_DIR=/tmp
        COMMIT=${{ inputs.COMMIT }}
        GEOS_EXPORT_DIR=GEOSX-and-TPL-${COMMIT:0:7}
        docker cp -a ${CONTAINER_NAME}:${GEOSX_TPL_DIR}/.. ${TMP_DIR}/${GEOS_EXPORT_DIR}
        GEOS_BUNDLE=${TMP_DIR}/${GEOS_EXPORT_DIR}.tar.gz
        tar czf ${GEOS_BUNDLE} --directory=${TMP_DIR} ${GEOS_EXPORT_DIR}
        CLOUDSDK_PYTHON=python3 gsutil cp -a public-read ${GEOS_BUNDLE} gs://${{ inputs.GCP_BUCKET }}/

    # - name: Setup upterm session
    #   uses: lhotari/action-upterm@v1
    #   with:
    #     ## limits ssh access and adds the ssh public key for the user which triggered the workflow
    #     limit-access-to-actor: true
    #     ## limits ssh access and adds the ssh public keys of the listed GitHub users
    #     limit-access-to-users: TotoGaz
  
    - name: Run integrated tests
      if: ${{ inputs.build_type == 'integrated_tests' }}
      run: |
        HC=${{ inputs.HOST_CONFIG }}
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --use-sccache ${{ inputs.USE_SCCACHE }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
          ${HC:+"--host-config ${HC}"} \
          ${{ inputs.BUILD_AND_TEST_ARGS }}
        exit_status=$?
        #
        TMP_DIR=/tmp
        COMMIT=${{ inputs.COMMIT }}
        GEOS_EXPORT_DIR=integratedTests-pr${{ github.event.number }}-${{ github.run_number }}-${COMMIT:0:7}
        mkdir -p ${TMP_DIR}/${GEOS_EXPORT_DIR}/{src,build}
        docker cp -a geos_build:/tmp/geos/integratedTests ${TMP_DIR}/${GEOS_EXPORT_DIR}/src
        docker cp -a geos_build:/tmp/build/integratedTests ${TMP_DIR}/${GEOS_EXPORT_DIR}/build
        GEOS_BUNDLE=${TMP_DIR}/${GEOS_EXPORT_DIR}.tar.gz
        tar czf ${GEOS_BUNDLE} --directory=${TMP_DIR} ${GEOS_EXPORT_DIR}
        CLOUDSDK_PYTHON=python3 gsutil cp -a public-read ${GEOS_BUNDLE} gs://${{ inputs.GCP_BUCKET }}/
        #
        exit ${exit_status}