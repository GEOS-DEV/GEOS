name: Build and Test Configuration
on:
  workflow_call:
    inputs:
      DOCKER_IMAGE_TAG:
        required: true
        type: string
      DOCKER_REPOSITORY:
        required: true
        type: string
      CMAKE_BUILD_TYPE:
        required: true
        type: string
      BUILD_AND_TEST_ARGS:
        required: false
        type: string
      HOST_CONFIG:
        required: false
        type: string
      ENABLE_HYPRE:
        required: false
        type: string
      ENABLE_HYPRE_DEVICE:
        required: false
        type: string
      ENABLE_TRILINOS:
        required: false
        type: string
      GCP_BUCKET:
        required: false
        type: string
      COMMIT:
        required: true
        type: string
      RUNS_ON:
        required: true
        type: string
      build_type:
        required: false
        type: string
        default: build
      USE_SCCACHE:
        required: false
        type: boolean
        default: true
    secrets:
      GOOGLE_CLOUD_GCP:
        required: false
jobs:
  build_and_test:
    runs-on: ${{ inputs.RUNS_ON }}
    env:
      # BUILD_AND_TEST_ARGS: ${{ inputs.BUILD_AND_TEST_ARGS }}
      ENABLE_HYPRE: ${{ inputs.ENABLE_HYPRE }}
      ENABLE_HYPRE_DEVICE: ${{ inputs.ENABLE_HYPRE_DEVICE }}
      ENABLE_TRILINOS: ${{ inputs.ENABLE_TRILINOS }}
      # HOST_CONFIG: ${{ inputs.HOST_CONFIG }}
      # USE_SCCACHE: ${{ inputs.USE_SCCACHE }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        submodules: true
        # lfs: ${{ inputs.build_type == 'integrated_tests' }}
        lfs: false
        fetch-depth: 1

    - id: 'auth'
      if: ${{ inputs.GCP_BUCKET || inputs.USE_SCCACHE }}
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CLOUD_GCP }}'
        create_credentials_file: true

    - name: 'Set up Cloud SDK'
      if: inputs.GCP_BUCKET
      uses: 'google-github-actions/setup-gcloud@v1'
      with:
        version: '>= 363.0.0'

    - name: Print environment
      run: printenv

    # Build and test only
    # Builds only the geosx executable (timeout when building tests)
    - name: Build and test
      if: ${{ inputs.build_type == 'build' && !(inputs.GCP_BUCKET) }}
      run: |
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --host-config ${{ inputs.HOST_CONFIG }} \
          --use-sccache ${{ inputs.USE_SCCACHE }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} ${{ inputs.BUILD_AND_TEST_ARGS }}

    # Build, test, uploads GEOSX and its TPL to GCP/GCS using gcloud CLI
    - name: Build and test and deploy
      if: ${{ inputs.build_type == 'build' && inputs.GCP_BUCKET }}
      run: |
        source ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --host-config ${{ inputs.HOST_CONFIG }} \
          --use-sccache ${{ inputs.USE_SCCACHE }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} ${{ inputs.BUILD_AND_TEST_ARGS }}
        TMP_DIR=/tmp
        COMMIT=${{ inputs.COMMIT }}
        GEOSX_EXPORT_DIR=GEOSX-and-TPL-${COMMIT:0:7}
        docker cp -a ${CONTAINER_NAME}:${GEOSX_TPL_DIR}/.. ${TMP_DIR}/${GEOSX_EXPORT_DIR}
        GEOSX_BUNDLE=${TMP_DIR}/${GEOSX_EXPORT_DIR}.tar.gz
        tar czf ${GEOSX_BUNDLE} --directory=${TMP_DIR} ${GEOSX_EXPORT_DIR}
        CLOUDSDK_PYTHON=python3 gsutil cp -a public-read ${GEOSX_BUNDLE} gs://${{ inputs.GCP_BUCKET }}/

    # - name: Setup upterm session
    #   uses: lhotari/action-upterm@v1
    #   with:
    #     ## limits ssh access and adds the ssh public key for the user which triggered the workflow
    #     limit-access-to-actor: true
    #     ## limits ssh access and adds the ssh public keys of the listed GitHub users
    #     limit-access-to-users: TotoGaz
  
    - name: Run integrated tests
      if: ${{ inputs.build_type == 'integrated_tests' }}
      run: |
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --host-config ${{ inputs.HOST_CONFIG }} \
          --use-sccache ${{ inputs.USE_SCCACHE }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} ${{ inputs.BUILD_AND_TEST_ARGS }}
