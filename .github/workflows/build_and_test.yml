name: Build and Test Configuration
on:
  workflow_call:
    inputs:
      BUILD_AND_TEST_ARGS:
        required: false
        type: string
      build_type:
        required: false
        type: string
        default: build
      CMAKE_BUILD_TYPE:
        required: true
        type: string
      DOCKER_IMAGE_TAG:
        required: true
        type: string
      DOCKER_REPOSITORY:
        required: true
        type: string
      ENABLE_HYPRE:
        required: false
        type: string
      ENABLE_HYPRE_DEVICE:
        required: false
        type: string
      ENABLE_TRILINOS:
        required: false
        type: string
      GCP_BUCKET:
        required: false
        type: string
      HOST_CONFIG:
        required: false
        type: string
      RUNS_ON:
        required: true
        type: string
      USE_SCCACHE:
        required: false
        type: boolean
        default: true
    secrets:
      GOOGLE_CLOUD_GCP:
        required: false
jobs:
  build_and_test:
    runs-on: ${{ inputs.RUNS_ON }}
    env:
      # Those env variables could be passed as scripts parameters as well,
      # but a specific care must be taken to be sure there's no conflict with the host-config files.
      ENABLE_HYPRE: ${{ inputs.ENABLE_HYPRE }}
      ENABLE_HYPRE_DEVICE: ${{ inputs.ENABLE_HYPRE_DEVICE }}
      ENABLE_TRILINOS: ${{ inputs.ENABLE_TRILINOS }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        submodules: true
        # lfs: ${{ inputs.build_type == 'integrated_tests' }}
        lfs: false
        fetch-depth: 1

    - id: 'auth'
      if: ${{ inputs.GCP_BUCKET || inputs.USE_SCCACHE }}
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CLOUD_GCP }}'
        create_credentials_file: true

    - name: 'Set up Cloud SDK'
      if: inputs.GCP_BUCKET
      uses: 'google-github-actions/setup-gcloud@v1'
      with:
        version: '>= 363.0.0'

    - name: Print environment
      run: printenv

    # Build and test only
    # Builds only the geos executable (timeout when building tests)
    - name: Build and test
      if: ${{ inputs.build_type == 'build' && !(inputs.GCP_BUCKET) }}
      run: |
        HOST_CONFIG=${{ inputs.HOST_CONFIG }}
        if ${{ inputs.USE_SCCACHE }} == 'true'; then
          SCCACHE_CLI="--sccache-credentials $(basename ${GOOGLE_GHA_CREDS_PATH})"
        fi
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
          ${HOST_CONFIG:+"--host-config ${HOST_CONFIG}"} \
          ${SCCACHE_CLI} \
          ${{ inputs.BUILD_AND_TEST_ARGS }}

    # Build, test, uploads geos and its TPL to GCP/GCS using gcloud CLI
    - name: Build and test and deploy
      if: ${{ inputs.build_type == 'build' && inputs.GCP_BUCKET }}
      run: |
        COMMIT=${{ github.event.pull_request.head.sha }}
        DATA_BASENAME_WE=GEOSX-and-TPL-${COMMIT:0:7}
        DATA_EXCHANGE_DIR=/tmp/exchange  # TODO maybe use /mnt size it has more free space?
        mkdir ${DATA_EXCHANGE_DIR}
        #
        HOST_CONFIG=${{ inputs.HOST_CONFIG }}
        if ${{ inputs.USE_SCCACHE }} == 'true'; then
          SCCACHE_CLI="--sccache-credentials $(basename ${GOOGLE_GHA_CREDS_PATH})"
        fi
        #
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --exchange ${DATA_EXCHANGE_DIR} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
          --data-basename-we ${ DATA_BASENAME_WE } \
          ${HOST_CONFIG:+"--host-config ${HOST_CONFIG}"} \
          ${SCCACHE_CLI} \
          ${{ inputs.BUILD_AND_TEST_ARGS }}
        #
        # Send to the bucket and print download link
        CLOUDSDK_PYTHON=python3 gsutil cp -a public-read ${DATA_EXCHANGE_DIR}/${DATA_BASENAME_WE}.tar.gz gs://${{ inputs.GCP_BUCKET }}/
        echo "Download the integrated tests at https://storage.googleapis.com/${{ inputs.GCP_BUCKET }}/${DATA_BASENAME_WE}.tar.gz"

        # # `source' command doesn't work with process substitution in bash, so we use an extra variable `HOST_CONFIG_CLI'.
        # HOST_CONFIG_CLI=${HOST_CONFIG:+"--host-config ${HOST_CONFIG}"}
        # if ${{ inputs.USE_SCCACHE }} == 'true'; then
        #   SCCACHE_CLI="--sccache-credentials $(basename ${GOOGLE_GHA_CREDS_PATH})"
        # fi
        # source ./scripts/ci_build_and_test.sh \
        #   --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
        #   --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
        #   -- \
        #   --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
        #   ${HOST_CONFIG_CLI} \
        #   ${SCCACHE_CLI} \
        #   ${{ inputs.BUILD_AND_TEST_ARGS }}
        # TMP_DIR=/tmp
        # GEOS_EXPORT_DIR=GEOSX-and-TPL-${GITHUB_SHA:0:7}
        # docker cp -a ${CONTAINER_NAME}:${GEOSX_TPL_DIR}/.. ${TMP_DIR}/${GEOS_EXPORT_DIR}
        # GEOS_BUNDLE=${TMP_DIR}/${GEOS_EXPORT_DIR}.tar.gz
        # tar czf ${GEOS_BUNDLE} --directory=${TMP_DIR} ${GEOS_EXPORT_DIR}
        # CLOUDSDK_PYTHON=python3 gsutil cp -a public-read ${GEOS_BUNDLE} gs://${{ inputs.GCP_BUCKET }}/

    # - name: Setup upterm session
    #   uses: lhotari/action-upterm@v1
    #   with:
    #     ## limits ssh access and adds the ssh public key for the user which triggered the workflow
    #     limit-access-to-actor: true
    #     ## limits ssh access and adds the ssh public keys of the listed GitHub users
    #     limit-access-to-users: TotoGaz
  
    - name: Run integrated tests
      if: ${{ inputs.build_type == 'integrated_tests' }}
      run: |
        COMMIT="${{ github.event.pull_request.head.sha }}"
        DATA_BASENAME_WE=integratedTests-pr${{ github.event.number }}-${{ github.run_number }}-${COMMIT:0:7}
        DATA_EXCHANGE_DIR=/tmp/exchange  # TODO maybe use /mnt size it has more free space?
        mkdir ${DATA_EXCHANGE_DIR}
        #
        HOST_CONFIG=${{ inputs.HOST_CONFIG }}
        if ${{ inputs.USE_SCCACHE }} == 'true'; then
          SCCACHE_CLI="--sccache-credentials $(basename ${GOOGLE_GHA_CREDS_PATH})"
        fi
        #
        ./scripts/ci_build_and_test.sh \
          --docker-repository ${{ inputs.DOCKER_REPOSITORY }} \
          --docker-tag ${{ inputs.DOCKER_IMAGE_TAG }} \
          --exchange ${DATA_EXCHANGE_DIR} \
          -- \
          --cmake-build-type ${{ inputs.CMAKE_BUILD_TYPE }} \
          --data-basename-we ${ DATA_BASENAME_WE } \
          ${HOST_CONFIG:+"--host-config ${HOST_CONFIG}"} \
          ${SCCACHE_CLI} \
          ${{ inputs.BUILD_AND_TEST_ARGS }}
        #
        # Send to the bucket and print download link
        CLOUDSDK_PYTHON=python3 gsutil cp -a public-read ${DATA_EXCHANGE_DIR}/${DATA_BASENAME_WE}.tar.gz gs://${{ inputs.GCP_BUCKET }}/
        echo "Download the integrated tests at https://storage.googleapis.com/${{ inputs.GCP_BUCKET }}/${DATA_BASENAME_WE}.tar.gz"
        exit ${exit_status}



# utiliser if: ${{ success() && inputs.build_type == 'build' }}
# utiliser if: ${{ inputs.build_type == 'integrated_tests' }}

